## 知识点复习

1. 数据库
2. JDBC
3. HTML
4. Servlet
5. JSP+EL+JSTL
6. AJAX
7. 多表操作

## 项目实现过程

### 大致结构

1. 分析静态页面，根据html或需求创建数据库
2. 填写测试数据
3. 创建项目，包结构(bean,dao,servlet,service,impl,util)，修改html页面为jsp

html->jsp

​		(1) 在HTML中添加page指令

​		(2) 将html的后缀改为jsp

4. 填写内容(注意顺序)

   1. bean：属性，封装方法，无参构造，全参构造

      表名=类名，列名=属性名

   2. dao：操作方法的接口，命名：实体类名+Dao

      Dbutils(属性文件，*propeties)

   3. impl：实现接口，命名：接口名+Impl

      继承Dbutils

   4. service.impl：定义接口，接口中的方法与dao中的方法一致

      impl：这层的实现类主要负责调取dao层方法

   5. servlet:

      //1.接收参数

      //2.调取service层方法，service又调取dao层方法

      //3.根据结果跳转页面

### 详细功能实现

#### 用户登录

1. 首先在 `login.jsp`中找到接受用户名和密码的输入框，将其`name`属性（也就是servlet要接收的参数）写为自己熟知的形式，我设置用户名为 `uname`，密码为 `upass`，同时，将整个页面放在form里面，定义action为 `/tologin`，也就是后面servlet定位

```jsp
<form action="/tologin" method="post">
<body id="userlogin_body">

......

</body>
</form>
```

```jsp
<div class="user_main_box">
		<ul>
			<li class="user_main_text">用户名： </li>
			<li class="user_main_input"><input name="uname" maxlength="20" id="TxtUserName" class="txtusernamecssclass"> </li>
		</ul>
		<ul>
			<li class="user_main_text">密 码： </li>
			<li class="user_main_input"><input type="password" name="upass" id="TxtPassword" class="txtpasswordcssclass"> </li>
		</ul>
```

2. 在web包下新建Java类 `LoginServlet`，顾名思义，并且写好三个步骤：接收参数、调取方法、跳转页面。并且取到会话的session并存值共前端显示当前用户到底是谁。

```java
package com.bob.web;
import...
@WebServlet(urlPatterns = {"/tologin"})
public class LoginServlet extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //接收参数
        String uname = req.getParameter("uname");
        String upass = req.getParameter("upass");

        //调取方法
        UsersService usersService = new UsersServiceImpl();
        Users users = usersService.login(uname, upass);
        
        //跳转页面
        if(users==null){
            resp.sendRedirect("/login.jsp");
        }else{
            //得到session并存值，供前端显示
            req.getSession().setAttribute("u1",users);
            resp.sendRedirect("/index.jsp");
        }
    }
}

```

3. 在service包中新建接口`UserService`，其中定义方法 `login`,接收两个参数即用户名和密码，并创建类 `UserServiceImpl`实现方法，具体实现即调用dao层的同名方法 `login`（三层架构的知识）

```java
package com.bob.service;

import com.bob.bean.Users;

public interface UsersService {
    //登录方法
    // sql select * from users where loginname = ? and password = ?
    public Users login(String uname, String upass);
}

```

```java
package com.bob.service.impl;

import com.bob.bean.Users;
import com.bob.dao.UsersDao;
import com.bob.dao.impl.UsersDaoImpl;
import com.bob.service.UsersService;

//service层本阶段主要用来直接调取dao层
public class UsersServiceImpl implements UsersService {
    private UsersDao usersDao= new UsersDaoImpl();//体现多态，声明接口new实现类
    @Override
    public Users login(String uname, String upass) {
        return usersDao.login(uname,upass);
    }
}

```

4. 同样的在Dao层进行相似的操作，只不过这里的实现类的方法真正操作数据库并且能返回一个user实例对象。

```java
package com.bob.dao;

import com.bob.bean.Users;

public interface UsersDao {
    public Users login(String uname, String upass);
}

```

```java
package com.bob.dao.impl;

import com.bob.bean.Users;
import com.bob.dao.DBUtils;
import com.bob.dao.UsersDao;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

//继承工具类方便操作数据库，再实现接口
public class UsersDaoImpl extends DBUtils implements UsersDao {
    Users user = null;//一个空的容器
    @Override
    public Users login(String uname, String upass) {

        try {
            //操作数据库
            String sql = "select * from users where loginname=? and password=?";

            List params = new ArrayList();
            params.add(uname);
            params.add(upass);

            resultSet = query(sql, params);
            while(resultSet.next()){
                //如果结果集里有数据，那么才初始化一个Users对象给到原来的空容器
                 user = new Users();
                 //user.setLoginName(uname);调取各种set方法设置对象的字段值
                 user.setLoginName(resultSet.getString("loginname"));
                 user.setRealName(resultSet.getString("realname"));

                 user.setPassword(resultSet.getString("password"));
            }
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            closeAll();
        }
        return user;
    }
}

```

到这里功能大致完成，但是如何防止用户在登录前就访问到了主页？

**过滤器**

1. 获取请求地址
2. 限定地址判断
3. 从session中获取对应用户信息
4. 若有值，正常继续访问，若没有值，重定向到登录页面

#### 学员列表展示

点击学生管理->到servlet中查询数据->显示在主页

1. 找到功能点页面：`left.jsp`,将路径改为自己设定的 `getstudents`，前两段是请求路径，最后一个是请求值。 

```jsp
<td>
	<a class=menuchild href="Educational/student/getstudents" target="right">学生管理</a>
</td>
```

2. 将整个路径拿到web层新建一个servlet（经典三步）

```java
package com.bob.web;

import com.bob.bean.Student;
import com.bob.service.StudentService;
import com.bob.service.impl.StudentServiceImpl;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;

@WebServlet(urlPatterns = {"/Educational/student/getstudents"})
public class FindStudentsServlet extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //1.接收参数
        //2.调用方法
        StudentService studentService = new StudentServiceImpl();
        List<Student> studentList = studentService.getall();
        //3.显示数据
        req.setAttribute("stulist",studentList);
        //注意这里list.jsp前不能加斜杠，加了斜杠它会从web根下开始寻找而不是想要的在Educational下寻找
        req.getRequestDispatcher("list.jsp").forward(req,resp);
    }
}

```

3. service层写接口，实现类，service的实现类中实例化一个dao层的对象，调用它的`getall()`方法

```java
package com.bob.service;

import com.bob.bean.Student;

import java.util.List;

public interface StudentService {
    //一行数据等价于一个对象，多行数据就是多个对象，显然这里我们查询到的肯定是多个对象
    public List<Student> getall();
}

```

```java
package com.bob.service.impl;

import com.bob.bean.Student;
import com.bob.dao.StudentDao;
import com.bob.dao.impl.StudentDaoImpl;
import com.bob.service.StudentService;

import java.util.List;

public class StudentServiceImpl implements StudentService {
    private StudentDao studentDao = new StudentDaoImpl();
    @Override
    public List<Student> getall() {
        return studentDao.getall();
    }
}

```

4. dao层操作数据库

```java
package com.bob.dao;

import com.bob.bean.Student;

import java.util.List;

public interface StudentDao {
    //一行数据等价于一个对象，多行数据就是多个对象，显然这里我们查询到的肯定是多个对象
    public List<Student> getall();
}

```

```java
package com.bob.dao.impl;

import com.bob.bean.Student;
import com.bob.dao.DBUtils;
import com.bob.dao.StudentDao;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

public class StudentDaoImpl extends DBUtils implements StudentDao {
    @Override
    public List<Student> getall() {
        //准备一个list
        List list = new ArrayList();
        try {
            //写sql
            String sql = "select * from student";
            //查出来的数据放到结果集中
            resultSet=query(sql,null);
            //取值
            while (resultSet.next()){
                Student student = new Student();
                student.setStuId(resultSet.getInt("stuid"));
                student.setStuNo(resultSet.getString("stuno"));
                student.setProfession(resultSet.getString("profession"));
                student.setRegDate(resultSet.getDate("regdate"));
                student.setStuName(resultSet.getString("stuname"));
                student.setAddress(resultSet.getString("address"));
                student.setSex(resultSet.getInt("sex"));
                student.setEmail(resultSet.getString("email"));
                student.setIdNumber(resultSet.getString("idnumber"));
                student.setIntroduction(resultSet.getString("introduction"));
                student.setPhone(resultSet.getString("phone"));
                student.setPolitics(resultSet.getString("politics"));
                list.add(student);
            }
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }finally {
            closeAll();
        }

        return list;
    }
}

```

做好上述工作后，来到前端 `list.jsp` 显示这个list

1. 引入标签库 `<%@taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>`
2. 将list存值并且遍历，找数据 **注意：stu.属性是bean实体类中的属性**

```jsp
<c:forEach items="${stulist}" var="stu"><!--将stulist中的对象存在stu中-->
					<tr id="product1">
                        <td align="center">${stu.stuNo}</td>
						<td align="center">${stu.stuName}</td>
						<td align="center">${stu.sex==1?'男':'女'}</td>
                        <td align="center">${stu.phone}</td>
						<td align="center">${stu.profession}</td>
                        <td align="center">${stu.regDate}</td>
						<td align="center">
							<a href="edit.jsp">修改</a>
							<a href="#">删除</a>
						</td> 				                    
                    </tr>
					</c:forEach>
```

​		

#### 分页

1. 找到jsp位置

```jsp
 <tr>
        <td colspan="20" style="text-align: center;">						
		<a style="text-decoration: none;" href="#">
      首页 上一页  ... 7 8 9 10 11 12 ... 下一页 尾页 共1234条 每页显示 10/23
      </a>
        </td>
 </tr>
```

2. 将每一条更改为超链接

```jsp
 <tr>
                        <td colspan="20" style="text-align: center;">						
						<a style="text-decoration: none;" href="#">首页</a>
						<a style="text-decoration: none;" href="#">上一页</a>
						<a style="text-decoration: none;" href="#">下一页</a>
						<a style="text-decoration: none;" href="#">尾页</a>
						共1234条
						10/23
                        </td>
                    </tr>
```

做分页的地址和做查询的地址实际上是一个地址

```jsp
 <tr>
                        <td colspan="20" style="text-align: center;">						
						<a style="text-decoration: none;" href="#">首页</a>
						<a style="text-decoration: none;" href="#">上一页</a>
						<a style="text-decoration: none;" href="#">下一页</a>
						<a style="text-decoration: none;" href="#">尾页</a>
						共1234条
						10/23
                        </td>
                    </tr>
```

先看servlet

```java
@WebServlet(urlPatterns = {"/Educational/student/getstudents"})
public class FindStudentsServlet extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //1.接收参数    pageIndex 当前页码值
        String pageIndex = req.getParameter("pageIndex");//分页首页
        int index =pageIndex==null?1:Integer.parseInt(pageIndex);
        //2.调用方法
        StudentService studentService = new StudentServiceImpl();
        List<Student> studentList = studentService.getall(index,5);
        //3.显示数据
        req.setAttribute("stulist",studentList);
        req.setAttribute("index",index);
        //注意这里list.jsp前不能加斜杠，加了斜杠它会从web根下开始寻找而不是想要的在Educational下寻找
        req.getRequestDispatcher("list.jsp").forward(req,resp);
    }
}

```

3. 传参数，传一个pageIndex给首页，默认为一，要实现分页，关键在于改sql语句，**利用关键字limit**，于是，修改Dao层中的sql，并且可以推导出需要的参数:`pageIndex`（当前页码）和 `pageSize`（页面大小）。同时，上一页和下一页也就是将当前页码加减一。**注意：jsp中的index是来自于servlet中存值：`req.setAttribute("index",index);`**

```jsp
<tr>
        <td colspan="20" style="text-align: center;">
		<a style="text-decoration: none;" href="/Educational/student/getstudents?pageIndex=1">首页</a>
		<a style="text-decoration: none;" href="/Educational/student/getstudents?pageIndex=${index>1?index-1:1}">上一页</a>
		<a style="text-decoration: none;" href="/Educational/student/getstudents?pageIndex=${index+1}">下一页</a>
		<a style="text-decoration: none;" href="/Educational/student/getstudents">尾页</a>
						共1234条
						10/23
        </td>
</tr>
```

```java
			//写sql
            String sql = "select * from student limit ?,?";
            //每页显示五条    pageSize=5 pageIndex=1,2,3,4,5
            //limit 0,5  5,5  10,5
            //limit (pageIndex-1)*pageSize,pageSize
             List params = new ArrayList();
             params.add((pageIndex-1)*pageSize);
             params.add(pageSize);
```

由于 `pageIndex`和 `pageSize`的存在，可以推理出getall()方法是需要传入这两个参数的，连带的，service层和dao层的方法都要加上这两个参数：**`public List<Student> getall(int pageIndex,int pageSize);`**

4. 限制用户只在有数据的页面浏览

解决上一页到0，用三元运算符： `index>1?index-1:1`

得到最后一页页码值：**总条数%pageSize>0?总条数/pageSize+1:总条数/pageSize**

得到总条数：Dao层添加方法，这里直接给出实现代码

```java
@Override
    public int totalCount() {
        int total = 0;
        try {
            resultSet = query("select count(*) from student", null);
            while (resultSet.next()){
                total=resultSet.getInt(1);
            }
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
        return total;
    }finally {
            closeAll();
        }
```

最终在servlet中加上代码：

```java
  //得到总页数 总条数%pageSize>0?总条数/pageSize+1:总条数/pageSize
        int totalCount = studentService.totalCount();

        int totalPage = totalCount%5>0?totalCount/5+1:totalCount/5;
  //顺便存下值
		req.setAttribute("totalPage",totalPage);
		req.setAttribute("totalCount",totalCount);
```

于是得到完备的分页jsp片段：

```jsp
 <tr>
                        <td colspan="20" style="text-align: center;">
						<a style="text-decoration: none;" href="/Educational/student/getstudents?pageIndex=1">首页</a>
						<a style="text-decoration: none;" href="/Educational/student/getstudents?pageIndex=${index>1?index-1:1}">上一页</a>
						<a style="text-decoration: none;" href="/Educational/student/getstudents?pageIndex=${index+1>=totalPage?totalPage:index+1}">下一页</a>
						<a style="text-decoration: none;" href="/Educational/student/getstudents?pageIndex=${totalPage}">尾页</a>
						共${totalCount}条
						${index}/${totalPage}
                        </td>
                    </tr>
```

#### 模糊查询

查询都用一个servlet，无论是模糊查还是全查

1. 找到表单

```jsp
<form action="#" method="get">
                    学生名称: 
					<input type="text"  />
                     学生学号: 
					<input type="text"  />
					性别: 
					<select>
							<option>--请选择--</option>
							<option>男</option>
							<option>女</option>
						</select>
					<input type="button" value="查询" />

                </form>
```

2. action替换为请求地址，method改为post，学生名称、性别和学号加上name即servlet要接收的参数，option上加上value。提交按钮type=submit

```jsp
 <form action="/Educational/student/getstudents" method="post">
                    学生名称: 
					<input type="text" name="stuName" />
                     学生学号: 
					<input type="text" name="stuNo" />
					性别: 
					<select name="stuSex">
							<option value="-1">--请选择--</option>
							<option value="1">男</option>
							<option value="0">女</option>
						</select>
					<input type="submit" value="查询" />

                </form>
```

3. 写servlet

   1. 接收参数并且转换为合适的数据类型

   ```java
   //获得模糊查的条件
           String stuName = req.getParameter("stuName");
           String stuNo = req.getParameter("stuNo");
           String stuSex = req.getParameter("stuSex");
           int sex = Integer.parseInt(stuSex);
   ```

   2. 改写getall方法，将这三者传入作为参数，这里给出最后Dao层中的具体实现，每一层的方法签名都要更改，同时total方法也应该加入这三者作为参数（因为总条数是由conunt(*)得到的，这里的总条数也是进行模糊查之后的总条数），total方法也进行重写。这里用到了 **这里用到了动态sql**，用StringBuffer实现

   ```java
    public List<Student> getall(int pageIndex,int pageSize,String stuName,String stuNo,int sex){
           //准备一个list
           List list = new ArrayList();
           try {
               StringBuffer dynamicSql = new StringBuffer("select * from student where 1=1 ");
               if(stuName!=null&&stuName.length()>0){
                   dynamicSql.append(" and stuname like ? ");
               }
               if(stuNo!=null&&stuNo.length()>0){
                   dynamicSql.append(" and stuno=? ");
               }
               if(sex!=-1){
                   dynamicSql.append(" and sex=? ");
               }
               dynamicSql.append(" limit ?,?");
   
                List params = new ArrayList();
   
                //判断参数是否存在并且传参进入动态sql中
               if(stuName!=null&&stuName.length()>0){
                   params.add("%"+stuName+"%");
               }
               if(stuNo!=null&&stuNo.length()>0){
                   params.add(stuNo);
               }
               if(sex!=-1){
                   params.add(sex);
               }
   
                params.add((pageIndex-1)*pageSize);
                params.add(pageSize);
               //查出来的数据放到结果集中  当用动态sql时注意要转为String类型，因为它本身是StringBuffer类型
               resultSet=query(dynamicSql.toString(),params);
               //取值
               while (resultSet.next()){
                   Student student = new Student();
                   student.setStuId(resultSet.getInt("stuid"));
                   student.setStuNo(resultSet.getString("stuno"));
                   student.setProfession(resultSet.getString("profession"));
                   student.setRegDate(resultSet.getDate("regdate"));
                   student.setStuName(resultSet.getString("stuname"));
                   student.setAddress(resultSet.getString("address"));
                   student.setSex(resultSet.getInt("sex"));
                   student.setEmail(resultSet.getString("email"));
                   student.setIdNumber(resultSet.getString("idnumber"));
                   student.setIntroduction(resultSet.getString("introduction"));
                   student.setPhone(resultSet.getString("phone"));
                   student.setPolitics(resultSet.getString("politics"));
                   list.add(student);
               }
           } catch (SQLException e) {
               throw new RuntimeException(e);
           }
   
           return list;
       }
   ```

   ```java
   public int totalCount(String stuName,String stuNo,int sex) {
           int total = 0;
           try {
               StringBuffer dynamicSql = new StringBuffer("select count(*) from student where 1=1  ");
               if(stuName!=null&&stuName.length()>0){
                   dynamicSql.append(" and stuname like ? ");
               }
               if(stuNo!=null&&stuNo.length()>0){
                   dynamicSql.append(" and stuno=? ");
               }
               if(sex!=-1){
                   dynamicSql.append(" and sex=? ");
               }
   
               List params = new ArrayList();
               //判断参数是否存在并且传参进入动态sql中
               if(stuName!=null&&stuName.length()>0){
                   params.add("%"+stuName+"%");
               }
               if(stuNo!=null&&stuNo.length()>0){
                   params.add(stuNo);
               }
               if(sex!=-1){
                   params.add(sex);
               }
   
               //resultSet = query("select count(*) from student", null);
               resultSet = query(dynamicSql.toString(),params);
               while (resultSet.next()){
                   total=resultSet.getInt(1);
               }
           } catch (SQLException e) {
               throw new RuntimeException(e);
           }finally {
               closeAll();
           }
           return total;
       }
   ```

   3. servlet中将模糊查条件存值，便于前端模糊查询的请求书写

   ```java
   //存储模糊查条件
           req.setAttribute("sname",stuName);
           req.setAttribute("sno",stuNo);
           req.setAttribute("ssex",sex);
   ```

   4. 在前端拼接补全模糊查询的请求参数（getall方法有五个参数，除了pageSize自己指定完了之外，全部要传过去）

   ```jsp
    <tr>
    <td colspan="20" style="text-align: center;">
   	<a style="text-decoration: none;" href="/Educational/student/getstudents?pageIndex=1&stuName=${sname}&stuNo=${sno}&stuSex=${ssex}">首页</a>
   	<a style="text-decoration: none;" href="/Educational/student/getstudents?pageIndex=${index>1?index-1:1}&stuName=${sname}&stuNo=${sno}&stuSex=${ssex}">上一页</a>
   	<a style="text-decoration: none;" href="/Educational/student/getstudents?pageIndex=${index+1>=totalPage?totalPage:index+1}&stuName=${sname}&stuNo=${sno}&stuSex=${ssex}">下一页</a>
   	<a style="text-decoration: none;" href="/Educational/student/getstudents?pageIndex=${totalPage}&stuName=${sname}&stuNo=${sno}&stuSex=${ssex}">尾页</a>
   	共${totalCount}条
   	${index}/${totalPage}
       </td>
    </tr>
   ```

#### 新增

逻辑：点击新增---查数据库获取年级列表---携带列表跳转编辑新增界面---编辑完成---点击添加按钮---回到主界面

1. 找到对应按钮前台，书写请求地址，并新建servlet

```jsp
<div class="div_head" style="width: 100%;text-align:center;">
		<span>
                <span style="float: left;">当前位置是：教务中心-》学生管理</span>
                <span style="float: right; margin-right: 8px; font-weight: bold;">
                    <a style="text-decoration: none;" href="/Educational/student/getgrades">【新增学生】</a>&emsp;&emsp;&emsp;&emsp;
                </span>
            </span>
	</div>
```

```java
package com.bob.web;

import...;

@WebServlet(urlPatterns = {"/Educational/student/getgrades"})
public class GetGradesServlet extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //接收参数
        //调取方法 -查询年级列表
        GradeService gradeService = new GradeServiceImpl();
        List<Grade> grades = gradeService.getGrades();
        //存值
        req.setAttribute("glist",grades);
        //跳转页面
        req.getRequestDispatcher("add.jsp").forward(req,resp);
    }
}

```

2. 新增GradeService、GradeDao等实例，写方法`getGrades`,这里给出Dao层具体实现

```java
package com.bob.dao.impl;

import com.bob.bean.Grade;
import com.bob.dao.DBUtils;
import com.bob.dao.GradeDao;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

public class GradeDaoImpl extends DBUtils implements GradeDao {

    @Override
    public List<Grade> getGrades() {
        List list = new ArrayList();
        try {
            String sql = "select * from grade";
            resultSet = query(sql,null);
            while (resultSet.next()){
                Grade grade = new Grade();
                grade.setGradeId(resultSet.getInt("gradeid"));
                grade.setGradeName(resultSet.getString("gradename"));
                list.add(grade);
            }
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            closeAll();
        }
        return list;
    }
}

```

3. 在 `add.jsp`中 循环遍历列表数据，注意引入标签库，这里给出核心实现，有源码在仓库可以细看

```jsp
 <tr>
                    <td>班级<span style="color:red">*</span>：</td>
                    <td>
                        <select>
                            <c:forEach items="${glist}" var="g">
                        	<option value="${g.gradeId}">${g.gradeName}</option>
                            </c:forEach>
                        </select>
                    </td>
                </tr>
```

4. 找到新增表单，新增请求路径，新增servlet，实现方法（炒剩饭）**这次参数多，用Student对象来封装参数**

   1. 表单中处理请求路径，设定请求参数名

   ```jsp
   <form action="/Educational/student/addstudent" method="post">
   	<table border="1" width="100%" class="table_a">
                   <tr  width="120px;">
                       <td width="10%">学号：<span style="color:red">*</span>：</td>
                       <td>
   						<input type="text"  name="sno" value="" />
   					</td>
                   </tr>
   
                   <tr  width="120px;">
                       <td>姓名<span style="color:red">*</span>：</td>
                       <td>
   						<input type="text"  name="sname" value="杨XX" />
   					</td>
                   </tr>
                 
                   <tr>
                       <td>年级<span style="color:red">*</span>：</td>
                       <td>
                           <select name="sgradeid">
                               <c:forEach items="${glist}" var="g">
                           	<option value="${g.gradeId}">${g.gradeName}</option>
                               </c:forEach>
                           </select>
                       </td>
                   </tr>
                   <tr>
                       <td>性别<span style="color:red">*</span>：</td>
                       <td>
                           <input type="radio" name="ssex" checked value="1" />男
                           <input type="radio" name="ssex" value="0"/>女
                       </td>
                   </tr>
   
   
   				<tr>
                       <td>EMAIL：</td>
                       <td>
                           <input type="text" name="semail" value="1332@126.com" />
                       </td>                
                   </tr>
   
   				<tr>
                       <td>联系电话：</td>
                       <td>
                           <input type="text" name="sphone" value="13333333333" />
                       </td>                
                   </tr>
   
   				<tr>
                       <td>户口所在地：</td>
                       <td>
                           <input type="text" name="slocation" value="北京"  />
                       </td>                
                   </tr>
   
   				<tr>
                       <td>住址：</td>
                       <td>
                           <input type="text" name="saddress" value="朝阳" />
                       </td>                
                   </tr>
   				<tr>
                       <td>政治面貌：</td>
                       <td>
                           <input type="text" name="spolitics" value="党员" />
                       </td>                
                   </tr>
   				<tr>
                       <td>身份证号：</td>
                       <td>
                           <input type="text" name="scardid" value="110111111111111111111" />
                       </td>                
                   </tr>
   				
   				<tr>
                       <td>专业：</td>
                       <td>
                           <input type="text" name="sprofession" value="java" />
                       </td>                
                   </tr>
   					
   				
   				<tr>
                       <td>简介<span style="color:red">*</span>：</td>
                       <td>
                           <textarea name="sdemo">一个新开辟领域的探讨，探讨摸索</textarea>
                       </td>
                   </tr>
   				<tr>
   					<td colspan=2 align="center">
   						<input type="submit" value="添加" /> 
   					</td> 
   				</tr>
   			</table>
   	</form>
   ```

   2. servlet

   ```java
   package com.bob.web;
   
   import com.bob.bean.Student;
   import com.bob.service.StudentService;
   import com.bob.service.impl.StudentServiceImpl;
   
   import javax.servlet.ServletException;
   import javax.servlet.annotation.WebServlet;
   import javax.servlet.http.HttpServlet;
   import javax.servlet.http.HttpServletRequest;
   import javax.servlet.http.HttpServletResponse;
   import java.io.IOException;
   
   @WebServlet(urlPatterns = {"/Educational/student/addstudent"})
   public class AddStudentServlet extends HttpServlet {
       @Override
       protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
           doPost(req, resp);
       }
   
       @Override
       protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
           //接收参数
            req.setCharacterEncoding("utf-8");
           String sno = req.getParameter("sno");
           String sname = req.getParameter("sname");
           String sgradeid = req.getParameter("sgradeid");
           //调取方法
           StudentServiceImpl studentService = new StudentServiceImpl();
           Student student = new Student();
           student.setStuNo(sno);
           student.setStuName(sname);
           student.setGid(Integer.parseInt(sgradeid));
           int result = studentService.insertStu(student);
           //跳转页面
           if(result>0){
               //新增成功，跳转到新的请求而非页面，因为list页面需要一个stulist，如果不走servlet查到它，会报错
               resp.sendRedirect("/Educational/student/getstudents");
           }else {
               //新增失败，跳转到添加界面让用户重新添加，同样的要走添加的servlet到add.jsp，因为页面需要glist
               resp.sendRedirect("/Educational/student/getgrades");
           }
       }
   }
   
   ```

   3. Dao中真正操作数据库的 `insertStudent()`方法,需要新增所有字段的话自行添加

   ```java
   @Override
       public int insertStu(Student student) {
           int update = 0;
           try {
               //写sql
               String sql = "insert into student(stuno,stuname,gid) values(?,?,?)";
               List params=new ArrayList();
               //从servlet一开始封装好了的对象中取出需要的参数
               params.add(student.getStuNo());
               params.add(student.getStuName());
               params.add(student.getGid());
   
               update = update(sql, params);
           } catch (Exception e) {
               throw new RuntimeException(e);
           }finally {
               closeAll();
           }
           return update;
       }
   ```

#### 删除

1. 给每一行做区分，用id

```jsp
<a href="/Educational/student/delstu?sid=${stu.stuNo}">删除</a>
```

2. servlet

```java
package com.bob.web;

import com.bob.service.StudentService;
import com.bob.service.impl.StudentServiceImpl;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.PrintWriter;

@WebServlet(urlPatterns = {"/Educational/student/delstu"})
public class DelStudentServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        doPost(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //接收参数
        String sid = req.getParameter("sid");
        //调取方法
        StudentService studentService = new StudentServiceImpl();
        int delled = studentService.del(sid);
        //跳转（刷新）页面
        //后台给前台一个弹窗
        resp.setContentType("text/html;charset=utf-8");
        PrintWriter writer = resp.getWriter();
        if(delled>0){
            writer.println("<script>alert('删除成功');location.href='/Educational/student/getstudents'</script>");
        }else{
            writer.println("<script>alert('删除失败');location.href='/Educational/student/getstudents'</script>");
        }
    }
}

```



2. 写方法

```java
 public int del(int sid) {
        int result = 0;
        try {
            String sql = "delete from student where stuno=?";
            List params = new ArrayList();
            params.add(sid);
            result = update(sql, params);
        } catch (Exception e) {
            throw new RuntimeException(e);
        } finally {
            closeAll();
        }
        return result;
    }
```

#### 主键查询

1. 找到修改超连接，定义请求路径

```jsp
<a href="/Educational/student/findbyid?sid=${stu.stuNo}">修改</a>
```

2. servlet

```java
package com.bob.web;

import com.bob.bean.Grade;
import com.bob.bean.Student;
import com.bob.service.GradeService;
import com.bob.service.StudentService;
import com.bob.service.impl.GradeServiceImpl;
import com.bob.service.impl.StudentServiceImpl;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;

@WebServlet(urlPatterns = {"/Educational/student/findbyid"})
public class FindByIdServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        doPost(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //接收参数
        String sid = req.getParameter("sid");
        //调取方法
        StudentService studentService = new StudentServiceImpl();
        Student stu = studentService.findbyid(sid);
        //跳转页面
        req.setAttribute("stu",stu);
        //查询年级列表
        GradeService gradeService = new GradeServiceImpl();
        List<Grade> grades = gradeService.getGrades();
        req.setAttribute("glist",grades);
        req.getRequestDispatcher("edit.jsp").forward(req,resp);
    }
}

```

3. 写方法

```java
 public Student findbyid(String sid) {
        Student student = new Student();
        try {
            String sql = "select * from student where stuno=?";
            List params = new ArrayList();
            params.add(sid);
            resultSet = query(sql, params);
            while (resultSet.next()){
                student.setStuId(resultSet.getInt("stuid"));
                student.setStuNo(resultSet.getString("stuno"));
                student.setProfession(resultSet.getString("profession"));
                student.setRegDate(resultSet.getDate("regdate"));
                student.setStuName(resultSet.getString("stuname"));
                student.setAddress(resultSet.getString("address"));
                student.setSex(resultSet.getInt("sex"));
                student.setEmail(resultSet.getString("email"));
                student.setIdNumber(resultSet.getString("idnumber"));
                student.setIntroduction(resultSet.getString("introduction"));
                student.setPhone(resultSet.getString("phone"));
                student.setPolitics(resultSet.getString("politics"));
                student.setGid(resultSet.getInt("gid"));
            }
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            closeAll();
        }

        return student;
    }
```

4. 在edit.jsp进行取值，这里只举几个例子

```jsp
 <form action="list.jsp" method="post">
	<table border="1" width="100%" class="table_a">
                <tr  width="120px;">
                    <td width="10%">学号：<span style="color:red">*</span>：</td>
                    <td>
						<input type="text"  name="f_goods_image" value="${stu.stuNo}" />
					</td>
                </tr>

                <tr  width="120px;">
                    <td>姓名<span style="color:red">*</span>：</td>
                    <td>
						<input type="text"  name="f_goods_image" value="${stu.stuName}" />
					</td>
                </tr>
                 
                <tr>
                    <td>班级<span style="color:red">*</span>：</td>
                    <td>
                        <select name="sgradeid">
                            <c:forEach items="${glist}" var="g">
                                <option value="${g.gradeId}" ${stu.gid==g.gradeId?'selected':''}>${g.gradeName}</option>
                            </c:forEach>
                        </select>
                    </td>
                </tr>
                <tr>
```



#### 修改

逻辑：查询需要修改的记录并展示---提供编辑---保存修改

字段太多，这里写到更改名字学号性别和年级

1. 添加servlet，**注意：当更新成功后要跳转到查找所有学生的servlet中再到list.jsp；更新失败后要跳转到主键查询的servlet中才能回到edit.jsp，而主键查询又需要一个sid，这个sid需要自己指定为当前更新失败的记录，即为本servlet接收到的参数sno**

```java
package com.bob.web;

import com.bob.bean.Student;
import com.bob.service.StudentService;
import com.bob.service.impl.StudentServiceImpl;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.PrintWriter;

@WebServlet(urlPatterns = {"/Educational/student/updatestu"})
public class UpdateStudentServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        doPost(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        //接收参数
        req.setCharacterEncoding("utf-8");
        String sno = req.getParameter("sno");
        String sname = req.getParameter("sname");
        String sgradeid = req.getParameter("sgradeid");
        String ssex = req.getParameter("ssex");
        //调取方法
        StudentService studentService = new StudentServiceImpl();
        Student student = new Student();
        student.setGid(Integer.parseInt(sgradeid));
        student.setStuName(sname);
        student.setStuNo(sno);
        student.setSex(Integer.parseInt(ssex));
        int i = studentService.updateStu(student);
        resp.setContentType("text/html;charset=utf-8");
        PrintWriter writer = resp.getWriter();
        if(i>0){
            writer.println("<script>alert('更新成功');location.href='/Educational/student/getstudents'</script>");
        }else{
            writer.println("<script>alert('更新失败');location.href='/Educational/student/findbyid?sid="+sno+"'</script>");
        }
    }
}

```

2. 写方法

```java
public int updateStu(Student student) {
        int result = 0;
        try {
            String sql= "update student set gid=?,stuname=?,sex=? where stuno=?";
            List params = new ArrayList();
            params.add(student.getGid());
            params.add(student.getStuName());
            params.add(student.getSex());
            params.add(student.getStuNo());
            result=update(sql,params);
        } catch (Exception e) {
            throw new RuntimeException(e);
        } finally {
            closeAll();
        }
        return result;
    }
```



## 代码优化

优化servlet，通过合并前置路径名相同的servlet，将其dopost方法中的内容提取出来作为归纳Servlet中的方法，例如，我将增加和删除学生两个servlet都合并在了StudentServlet中，定义一个参数method，在前端只需要加上判定method为什么值再来调用具体的方法

```java
package com.bob.web;

import com.bob.bean.Student;
import com.bob.service.StudentService;
import com.bob.service.impl.StudentServiceImpl;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.PrintWriter;

@WebServlet(urlPatterns = {"/Educational/student"})
public class StudentServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {

        doPost(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String method = req.getParameter("method");//假定一个参数，key值为method，表示传递请求目的
        if(method.equals("addstudent")){
            addstudent(req, resp);
        }else if (method.equals("delstu")){
            delstudent(req, resp);
        }
    }
    //新增学生
    protected void addstudent(HttpServletRequest req,HttpServletResponse resp) throws IOException {
        //接收参数
        req.setCharacterEncoding("utf-8");
        String sno = req.getParameter("sno");
        String sname = req.getParameter("sname");
        String sgradeid = req.getParameter("sgradeid");
        String ssex = req.getParameter("ssex");
        String semail = req.getParameter("semail");
        String sphone = req.getParameter("sphone");
        String slocation = req.getParameter("slocation");
        String saddress = req.getParameter("saddress");
        String spolitics = req.getParameter("spolitics");
        String scardid = req.getParameter("scardid");
        String sprofession = req.getParameter("sprofession");
        String sdemo = req.getParameter("sdemo");
        //调取方法
        StudentServiceImpl studentService = new StudentServiceImpl();
        Student student = new Student();
        student.setStuNo(sno);
        student.setStuName(sname);
        student.setGid(Integer.parseInt(sgradeid));
        student.setSex(Integer.parseInt(ssex));
        student.setEmail(semail);
        student.setPhone(sphone);
        student.setRegistered(slocation);
        student.setAddress(saddress);
        student.setPolitics(spolitics);
        student.setIdNumber(scardid);
        student.setProfession(sprofession);
        student.setIntroduction(sdemo);
        int result = studentService.insertStu(student);
        //跳转页面
        if(result>0){
            //新增成功，跳转到新的请求而非页面，因为list页面需要一个stulist，如果不走servlet查到它，会报错
            resp.sendRedirect("/Educational/student/getstudents");
        }else {
            //新增失败，跳转到添加界面让用户重新添加，同样的要走添加的servlet到add.jsp，因为页面需要glist
            resp.sendRedirect("/Educational/student/getgrades");
        }
    }
    //删除学生
    protected void delstudent(HttpServletRequest req,HttpServletResponse resp) throws IOException {
        //接收参数
        String sid = req.getParameter("sid");
        //调取方法
        StudentService studentService = new StudentServiceImpl();
        int delled = studentService.del(sid);
        //跳转（刷新）页面
        //后台给前台一个弹窗
        resp.setContentType("text/html;charset=utf-8");
        PrintWriter writer = resp.getWriter();
        if(delled>0){
            writer.println("<script>alert('删除成功');location.href='/Educational/student/getstudents'</script>");
        }else{
            writer.println("<script>alert('删除失败');location.href='/Educational/student/getstudents'</script>");
        }
    }
    }


```

前台请求变更：加上了对method的判定

```jsp
<a href="/Educational/student?method=delstu&sid=${stu.stuNo}">删除</a>
```

```jsp
<form action="/Educational/student?method=addstudent" method="post">
```

